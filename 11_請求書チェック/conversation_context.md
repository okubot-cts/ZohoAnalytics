# 請求書チェック・商談分析 会話コンテキスト

## 分析の流れと重要な発見

### 初期の課題
- ZohoCRM商談データとZohoBooks請求書データの整合性チェック
- 請求漏れの発見・分析
- 特にJT ETPケースでの¥897,798の差額の原因調査

### JT ETEケースの詳細分析

#### 基本情報
- **親商談**: 【2025】JT ETP _事務局（ID: 5187347000129692086）
- **親商談金額**: ¥0（事務局のため）
- **子商談数**: 531件
- **分析対象**: 「受注」かつ商談名に「後期」を含まない商談

#### 段階的な発見プロセス

1. **最初の分析**
   - 88件の子商談のみ取得（¥14,908,559 税抜き）
   - 請求書¥15,501,617との差額¥897,798を発見

2. **トークン期限切れ問題**
   - API 401エラーでデータ取得失敗
   - ユーザーから新しい認証コード提供
   - `1000.4bd1c7bdb988a5a658e9dc0d5d982228.d347db56bb121322f13ffbe13e9738e3`

3. **完全データ取得**
   - 531件すべての子商談を取得
   - 「後期」なし: 389件（¥84,193,885 税抜き、¥92,613,274 税込み）
   - 「後期」あり: 95件（¥17,129,056 税抜き）

4. **消費税の重要な発見**
   - **商談金額**: 税抜き
   - **請求書金額**: 税込み
   - 比較には商談金額×1.10が必要

5. **7月入金調査**
   - 6月まで入金: ¥91,079,160
   - 差額: ¥1,534,114
   - 7月のJT ETP関連入金を調査したが、実際は非JT ETP入金だった

6. **最終的な発見**
   - 親商談ID「5187347000129692086」から発行された請求書を発見
   - 請求書総額: ¥92,613,274（draft分¥220除く）
   - 商談総額（税込み）: ¥92,613,274
   - **完全一致を確認！**

### 商談・請求書の5つのパターン

#### パターン分類の発見
1. **パターン1**: 親商談完結（親商談のみで請求）
2. **パターン2**: 子商談完結（親金額ゼロ、子商談で請求）
3. **パターン3**: 親統括・金額なし（親から子商談分を一括請求）← JT ETEパターン
4. **パターン4**: 親統括・金額あり（親から全体を請求）
5. **パターン5**: 自己負担・会社負担分担（親子両方で請求）

#### 実例の確認
- **JT ETE**: パターン3（親¥0、子商談分を親から一括請求）
- **野村證券**: パターン2（親¥0、子商談で個別請求）
- **東電設計**: パターン5（親¥2,565,870、子¥2,271,208で分担）
- **GSK**: パターン4（親¥1、子¥6,922,268、親から全体請求）

### 全体データ分析

#### 2024/4/1以降の全商談
- **総商談数**: 9,800件
- **総額（税抜き）**: ¥479,232,850
- **総額（税込み）**: ¥527,156,135

#### ステージ別内訳
1. **受注**: 5,850件 - ¥265,150,300（55.3%）
2. **開講待ち**: 1,750件 - ¥172,407,550（36.0%）
3. **クロージング**: 50件 - ¥16,402,000（3.4%）
4. **決済待ち**: 550件 - ¥11,713,250（2.4%）
5. **キャンセル**: 550件 - ¥5,033,950（1.1%）

#### 親子構造の発見
- **親商談候補**: 41個
- **親子関係グループ**: 41組
- **期間フィルタの影響**: 親商談のClosing_Dateが2024/4/1より前のため、親子関係が見えにくい

### 技術的な学び

#### トークン管理
- **CRMトークン**: 1時間有効、リフレッシュトークンで更新
- **Booksトークン**: 同様に1時間有効
- 自動更新スクリプトを作成

#### API制限対策
- ページング処理（200件ずつ）
- リクエスト間隔調整（0.2-0.5秒）
- エラーハンドリング

#### データ構造の理解
- **field78**: 親商談への参照フィールド
- **reference_number**: 請求書の商談ID参照
- **Stage**: 商談の進行状況
- **Amount**: 税抜き金額

### 重要な結論

1. **JT ETEケースは完全整合**
   - 商談¥92,613,274（税込み）= 請求書¥92,613,274

2. **主要パターンはパターン3**
   - 親商談（事務局）が¥0
   - 子商談の金額を親商談から一括請求

3. **消費税処理が重要**
   - 商談と請求書の比較時は必ず税込み換算

4. **期間フィルタの注意点**
   - 親商談は契約時期（年度開始前）
   - 子商談はサービス提供時期
   - 両方を考慮した分析が必要

### 作成したスクリプト一覧

#### 主要分析スクリプト
- `get_jt_etp_complete_531_deals.py`: JT ETP完全分析
- `comprehensive_all_deals_analysis.py`: 全商談5パターン分析
- `final_pattern_analysis.py`: 最終パターン検証
- `check_parent_deal_invoices.py`: 親商談請求書確認

#### トークン・認証管理
- `auto_refresh_books_token_and_check_july.py`: Books自動トークン更新
- `refresh_crm_token_and_analyze.py`: CRM自動トークン更新

#### 入金・差額分析
- `verify_june_july_payments.py`: 6-7月入金確認
- `analyze_payment_difference.py`: 差額原因分析
- `verify_tax_calculation.py`: 税計算検証

### 次に確認すべき項目

1. **全データでの総額・請求金額・入金金額の確認**
2. **請求書カバー率の算出**
3. **未請求・未入金の特定**
4. **各パターンでの整合性検証**

このコンテキストを基に、包括的な最終分析を実行予定。