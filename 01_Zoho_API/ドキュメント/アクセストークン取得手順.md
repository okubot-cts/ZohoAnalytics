# Zoho Analytics API アクセストークン取得手順

## 📋 概要

Zoho Analytics APIを使用するには、アクセストークンが必要です。以下の方法で取得できます。

## 🔑 取得方法

### 方法1: リフレッシュトークンから取得（推奨）

以前に取得したリフレッシュトークンがある場合：

```bash
python3 get_access_token.py
```

選択肢で「1」を選択し、以下を入力：
- **リフレッシュトークン**: 以前取得したリフレッシュトークン
- **クライアントID**: Zoho Developer Consoleで取得したクライアントID
- **クライアントシークレット**: Zoho Developer Consoleで取得したクライアントシークレット

### 方法2: 認証コードから取得

初回取得の場合：

1. **Zoho Developer Consoleでアプリケーション作成**:
   - [Zoho Developer Console](https://api-console.zoho.com/)にアクセス
   - 「Add Client」をクリック
   - アプリケーション名を入力
   - 「Self Client」を選択
   - リダイレクトURIを設定（例: `http://localhost:8080/callback`）

2. **認証URLを生成**:
   ```
   https://accounts.zoho.com/oauth/v2/auth?
   scope=ZohoAnalytics.data.READ,ZohoAnalytics.schema.READ&
   client_id=YOUR_CLIENT_ID&
   response_type=code&
   redirect_uri=YOUR_REDIRECT_URI&
   access_type=offline
   ```

3. **認証コードを取得**:
   - 上記URLにアクセス
   - Zohoアカウントでログイン
   - 認証を許可
   - リダイレクトURLから認証コードを取得

4. **アクセストークンを取得**:
   ```bash
   python3 get_access_token.py
   ```
   選択肢で「2」を選択し、以下を入力：
   - **認証コード**: 上記で取得した認証コード
   - **クライアントID**: アプリケーションのクライアントID
   - **クライアントシークレット**: アプリケーションのクライアントシークレット
   - **リダイレクトURI**: 設定したリダイレクトURI

### 方法3: 手動でトークンを入力

既にアクセストークンを持っている場合：

```bash
python3 get_access_token.py
```

選択肢で「3」を選択し、以下を入力：
- **アクセストークン**: 既に取得したアクセストークン
- **ワークスペースID**: Zoho AnalyticsのワークスペースID

## 🔍 ワークスペースIDの確認方法

1. **Zoho Analyticsにログイン**
2. **ワークスペース一覧を確認**
3. **URLからワークスペースIDを取得**:
   ```
   https://analytics.zoho.com/workspace/{WORKSPACE_ID}/home
   ```

## 📁 保存されるファイル

### トークン情報ファイル
- `token_info_YYYYMMDD_HHMMSS.json`: トークン情報
- `.env`: 環境変数設定ファイル

### トークン情報の内容
```json
{
  "access_token": "1000.xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx.xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",
  "refresh_token": "1000.xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx.xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",
  "api_domain": "https://www.zohoapis.com",
  "token_type": "Bearer",
  "expires_in": 3600
}
```

## ⚠️ 注意事項

### セキュリティ
- アクセストークンは機密情報です
- `.env`ファイルは`.gitignore`に追加してください
- トークン情報ファイルは安全に保管してください

### トークンの有効期限
- アクセストークン: 1時間（3600秒）
- リフレッシュトークン: 無期限（手動で無効化するまで）

### 自動更新
リフレッシュトークンがあれば、アクセストークンは自動的に更新できます：

```python
# トークンが期限切れの場合、自動的に更新
if token_expired:
    new_token = get_access_token_from_refresh(refresh_token, client_id, client_secret)
```

## 🔧 トラブルシューティング

### よくあるエラー

#### 1. 認証エラー
```
❌ トークン取得エラー: 401 Unauthorized
```
**解決方法**: クライアントIDとクライアントシークレットを確認

#### 2. リダイレクトURIエラー
```
❌ トークン取得エラー: 400 Bad Request
```
**解決方法**: リダイレクトURIが正確に一致することを確認

#### 3. スコープエラー
```
❌ トークン取得エラー: 403 Forbidden
```
**解決方法**: 適切なスコープ（ZohoAnalytics.data.READ等）を設定

### デバッグ方法

```bash
# 詳細なログを有効にする
export DEBUG=1
python3 get_access_token.py
```

## 📞 サポート

問題が発生した場合は、以下を確認してください：

1. **ネットワーク接続**: インターネット接続が安定しているか
2. **認証情報**: クライアントIDとクライアントシークレットが正しいか
3. **スコープ設定**: Zoho Analytics APIのスコープが設定されているか
4. **リダイレクトURI**: 正確に一致しているか

## 📚 参考資料

- [Zoho Analytics API v2 ドキュメント](https://www.zoho.com/analytics/api/v2/introduction.html)
- [Zoho Developer Console](https://api-console.zoho.com/)
- [OAuth 2.0 認証ガイド](https://www.zoho.com/analytics/api/v2/oauth-guide.html) 