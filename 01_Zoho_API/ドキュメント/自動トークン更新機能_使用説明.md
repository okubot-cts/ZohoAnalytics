# Zoho Analytics API 自動トークン更新機能 使用説明

## 📋 概要

この機能は、Zoho Analytics APIを使用する際に、アクセストークンの有効期限を自動的に管理し、必要に応じて自動更新を行うシステムです。

## 🔧 機能特徴

### ✅ 自動トークン管理
- **有効期限監視**: アクセストークンの有効期限を自動監視
- **自動更新**: 期限切れ前に自動的にリフレッシュトークンを使用して更新
- **環境変数更新**: 更新されたトークンを自動的に環境変数に反映
- **バックアップ機能**: トークンファイルの自動バックアップ

### ✅ エラーハンドリング
- **認証エラー対応**: 401エラー時に自動的にトークン更新を試行
- **再試行機能**: トークン更新後の自動再試行
- **ログ機能**: 詳細なログ出力とエラー追跡

### ✅ セキュリティ
- **安全な保存**: トークンファイルの暗号化（オプション）
- **バックアップ**: 更新前のトークンファイルを自動バックアップ
- **タイムスタンプ**: 更新履歴の追跡

## 🚀 使用方法

### 1. 作業開始時の自動更新

```bash
# 作業開始スクリプトを実行
python3 01_Zoho_API/認証・トークン/start_work.py
```

このスクリプトは以下を自動実行します：
- 環境設定確認
- 自動トークン更新
- API接続テスト
- 次のステップの表示

### 2. 手動での自動更新

```bash
# 自動トークン管理システムを直接実行
python3 01_Zoho_API/認証・トークン/auto_token_manager.py
```

### 3. APIクライアントでの自動更新

```python
from zoho_analytics_api_client_auto import ZohoAnalyticsAPIAuto

# 自動トークン更新機能付きAPIクライアントを初期化
client = ZohoAnalyticsAPIAuto(auto_refresh=True)

# クエリ実行（必要に応じて自動的にトークン更新）
result = client.execute_query("SELECT * FROM 連絡先 LIMIT 10")
```

## 📁 ファイル構成

```
01_Zoho_API/
├── 認証・トークン/
│   ├── auto_token_manager.py      # 自動トークン管理システム
│   ├── start_work.py              # 作業開始スクリプト
│   └── token_manager.py           # 従来のトークン管理
├── APIクライアント/
│   ├── zoho_analytics_api_client_auto.py  # 自動更新機能付きAPIクライアント
│   └── zoho_analytics_api_client.py       # 従来のAPIクライアント
├── 設定ファイル/
│   ├── zoho_config.json           # クライアント設定
│   └── zoho_tokens.json           # トークン情報
└── ドキュメント/
    └── 自動トークン更新機能_使用説明.md  # このファイル
```

## ⚙️ 設定

### 設定ファイル (`zoho_config.json`)

```json
{
  "client_id": "your_client_id",
  "client_secret": "your_client_secret",
  "org_id": "your_org_id"
}
```

### トークンファイル (`zoho_tokens.json`)

```json
{
  "access_token": "your_access_token",
  "refresh_token": "your_refresh_token",
  "scope": "ZohoAnalytics.fullaccess.all",
  "api_domain": "https://www.zohoapis.com",
  "token_type": "Bearer",
  "expires_in": 3600,
  "created_at": "2025-08-09T05:26:42.123456",
  "refreshed_at": "2025-08-09T05:26:42.123456"
}
```

## 🔄 自動更新の仕組み

### 1. 有効期限チェック
- アクセストークンの作成時刻と有効期限を確認
- 5分のマージンを設けて期限切れ前に更新

### 2. 自動更新プロセス
1. リフレッシュトークンを使用して新しいアクセストークンを取得
2. 新しいトークンをファイルに保存
3. 環境変数を更新
4. バックアップファイルを作成

### 3. エラー時の対応
- 401認証エラー時に自動的にトークン更新を試行
- 更新後の自動再試行
- 詳細なエラーログの出力

## 📊 ログ機能

### ログファイル
- `logs/token_manager.log`: トークン管理の詳細ログ

### ログレベル
- **INFO**: 通常の操作ログ
- **WARNING**: 警告メッセージ
- **ERROR**: エラーメッセージ

### ログ内容
- トークン更新の実行
- 有効期限チェック
- エラー詳細
- 環境変数更新

## 🧪 テスト・検証

### 1. トークン状態確認

```bash
# トークン管理システムで状態確認
python3 01_Zoho_API/認証・トークン/auto_token_manager.py
```

### 2. API接続テスト

```bash
# 自動更新機能付きAPIクライアントでテスト
python3 01_Zoho_API/APIクライアント/zoho_analytics_api_client_auto.py
```

### 3. 手動テスト

```python
from zoho_analytics_api_client_auto import ZohoAnalyticsAPIAuto

# 自動更新機能を無効にしてテスト
client = ZohoAnalyticsAPIAuto(auto_refresh=False)

# 自動更新機能を有効にしてテスト
client = ZohoAnalyticsAPIAuto(auto_refresh=True)
```

## 🔍 トラブルシューティング

### よくある問題

#### 1. 設定ファイルが見つからない
```
❌ 設定ファイルが見つかりません: 01_Zoho_API/設定ファイル/zoho_config.json
```

**解決方法**:
- 設定ファイルが正しい場所にあるか確認
- `zoho_config.json`ファイルの内容を確認

#### 2. リフレッシュトークンが無効
```
❌ トークン更新エラー: 400 Bad Request
```

**解決方法**:
- リフレッシュトークンが正しいか確認
- クライアントIDとクライアントシークレットを確認

#### 3. ネットワークエラー
```
❌ APIリクエストエラー: Connection timeout
```

**解決方法**:
- ネットワーク接続を確認
- ファイアウォール設定を確認

### デバッグ方法

#### 詳細ログの有効化
```python
import logging
logging.basicConfig(level=logging.DEBUG)
```

#### 手動でのトークン更新
```bash
python3 01_Zoho_API/認証・トークン/auto_refresh_token.py
```

## 📈 パフォーマンス

### 更新頻度
- **有効期限**: 1時間（3600秒）
- **マージン時間**: 5分
- **実際の更新間隔**: 55分

### 処理時間
- **トークン更新**: 通常1-3秒
- **環境変数更新**: 即座
- **バックアップ作成**: 1秒未満

## 🔒 セキュリティ考慮事項

### トークン保護
- トークンファイルは`.gitignore`に追加
- ファイルパーミッションを適切に設定
- 定期的なトークンローテーション

### 環境変数
- 本番環境では環境変数での管理を推奨
- シェル履歴にトークンが残らないよう注意

### ログファイル
- ログファイルに機密情報が含まれないよう注意
- 定期的なログローテーション

## 📚 参考資料

- [Zoho Analytics API v2 ドキュメント](https://www.zoho.com/analytics/api/v2/introduction.html)
- [OAuth 2.0 認証ガイド](https://www.zoho.com/analytics/api/v2/oauth-guide.html)
- [Zoho API接続ガイド](Zoho_API_接続ガイド.md)

## 🆘 サポート

問題が発生した場合は、以下を確認してください：

1. **ログファイル**: `logs/token_manager.log`を確認
2. **設定ファイル**: `zoho_config.json`の内容を確認
3. **ネットワーク**: インターネット接続を確認
4. **認証情報**: クライアントIDとシークレットを確認

---

*最終更新: 2025年8月9日*
*バージョン: 1.0* 